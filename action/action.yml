name: 'Generate privacy-aware dbt models'
description: 'Generate privacy-aware dbt models'
inputs:
  github_token:
    description: 'GITHUB_TOKEN'
    required: true
  working_directory:
    description: 'Working directory of a dbt project relative to the root directory.'
    required: true
  dbt_models_dir:
    description: "Path for models from the working directory"
    required: true
  dbt_profiles_dir:
    description: "Which directory to look in for the profiles.yml file."
    required: false
    default: ""
  dbt_profile:
    description: "Which profile to load."
    required: false
    default: ""
  dbt_target:
    description: "Which target to load for the given profile"
    required: false
    default: ""
  dbt_vars_path:
    description: "A YAML file to supply variables to the dbt project."
    required: false
    default: ""
  delete_before:
    description: 'Delete dbt models generated by dbt-data-privacy ahead of time, if it is `1`.'
    required: false
    default: "1"
  verbose:
    description: "verbose if it is '1'."
    required: false
    default: "1"

outputs:
  generated-models-json:
    description: 'The JSON object string of generated models'
    value: ${{ steps.generated-models.outputs.generated-models-json }}

runs:
  using: 'composite'
  steps:
    - id: generate-models
      shell: bash
      working-directory: "${{ inputs.working_directory }}"
      run: |
        bash ${GITHUB_ACTION_PATH}/generate_models.sh \
          --dbt-profiles-dir "${{ inputs.dbt_profiles_dir }}" \
          --dbt-profile "${{ inputs.dbt_profile }}" \
          --dbt-target "${{ inputs.dbt_target }}" \
          --dbt-vars-path "${{ inputs.dbt_vars_path }}" \
          --dbt-models-dir "${{ inputs.dbt_models_dir }}" \
          --delete-before "${{ inputs.delete_before }}" \
          --verbose "${{ inputs.verbose }}"
    - id: git-push
      shell: bash
      env:
        GITHUB_TOKEN: ${{ inputs.github_token }}
      run: |
        git remote set-url origin https://github-actions:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}
        git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add --force "${{ inputs.dbt_models_dir }}"
        git commit -m "Generate dbt models by dbt-data-privacy"
        git push origin HEAD:"${GITHUB_REF}"
#    - uses: stefanzweifel/git-auto-commit-action@v4
#      with:
#        commit_message: "Generate dbt models by dbt-data-privacy"
#        commit_options: '--signoff'
#        commit_user_name: "github-actions[bot]"
#        commit_user_email: "41898282+github-actions[bot]@users.noreply.github.com"
#        commit_author: "GitHub Action <41898282+github-actions[bot]@users.noreply.github.com>"
